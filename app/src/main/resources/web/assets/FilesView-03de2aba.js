import{aR as Le,o as f,c as C,b as y,r as m,U as B,aS as Qe,aT as q,ae as X,aU as Re,i as Y,aV as He,u as ee,t as J,aW as N,aX as G,aY as Ne,aZ as pe,au as Ge,R as Ue,a_ as We,a$ as ze,s as K,a as _e,b0 as Ze,b1 as je,b2 as ge,d as be,Y as Oe,$ as Xe,Q as R,v as H,g as i,f as V,n as Ye,B as Je,p as Ke,ac as et,G as tt,H as at,I as nt,e as Z,J as st,M as ot,N as lt,F as L,y as me,x as it,k as M,a9 as ct,j as Q,P as ut,l as j,X as O,ah as rt,_ as dt}from"./index-3c761cf5.js";import{_ as pt}from"./Breadcrumb-55791723.js";import{c as he}from"./index-a6b2ba68.js";import{g as ve,M as mt}from"./splitpanes.es-e062590b.js";import{n as ht}from"./list-6498ebd9.js";import{b as vt,c as ft}from"./search-2c6de17f.js";import{b as _t}from"./baseIndexOf-70b929c6.js";import{a as gt}from"./toInteger-fcc38b03.js";import{_ as bt}from"./VModal.vuevuetypescriptsetuptruelang-d5392689.js";import{_ as fe}from"./EditValueModal.vuevuetypescriptsetuptruelang-7d8bcc18.js";import"./vee-validate.esm-7f7a9a56.js";var yt=Math.max;function kt(s,e,t){var a=s==null?0:s.length;if(!a)return-1;var n=t==null?0:gt(t);return n<0&&(n=yt(a+n,0)),_t(s,Le(e),n)}const Dt={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"},wt=y("path",{fill:"currentColor",d:"M4 20q-.825 0-1.413-.588T2 18V6q0-.825.588-1.413T4 4h5.175q.4 0 .763.15t.637.425L12 6h8q.825 0 1.413.588T22 8v10q0 .825-.588 1.413T20 20H4ZM4 6v12h16V8h-8.825l-2-2H4Zm0 0v12V6Z"},null,-1),Ct=[wt];function xt(s,e){return f(),C("svg",Dt,Ct)}const It={name:"material-symbols-folder-outline-rounded",render:xt},Vt=(s,e)=>{const t=m("");return{createPath:t,createVariables(a){return{path:t.value+"/"+a}},createMutation(){return B({document:Qe,options:{update:async(a,n)=>{const{fileIdToken:o}=s.value;for(const c of e.value)if(c.dir===t.value){const u=n.data.createDir;c.items.push({...u,name:q(u.path),fileId:await X(o,u.path)})}}},appApi:!0})}}},$t=s=>{const e=m(""),t=m("");return{renameValue:e,renamePath:t,renameDone(a){const n=t.value,o=e.value;for(const c of s.value)c.rename(n,o,a)},renameMutation(){return B({document:Re,appApi:!0})},renameVariables(a){return{path:t.value,name:a}}}},Ft=(s,e,t)=>({onDeleted(a){for(const n of s.value)n.deleteItem(a.path);if(e.value.startsWith(a.path)){const n=a.path.lastIndexOf("/");e.value=a.path.substring(0,n)}t()}}),Mt=()=>{const s=m(0),e=m(0),{refetch:t}=Y({handle:(a,n)=>{n||(s.value=a.storageStats.totalBytes,e.value=a.storageStats.freeBytes)},document:He,appApi:!0});return{totalBytes:s,freeBytes:e,refetch:t}},Tt=(s,e)=>{const t=m(""),a=m(""),n=m(""),o=m([]),{t:c}=ee();let u=0;const{loading:F}=Y({handle:async(k,x)=>{if(x)J(c(x),"error");else{const{dir:v,items:I}=k.files;n.value===""&&(t.value=v);const{fileIdToken:$}=s.value,D=[];for(const d of I){const g={...d,name:q(d.path)};(N(g.name)||G(g.name))&&(g.fileId=await X($,d.path)),D.push(g)}const _=v.replace(t.value,"").split("/").length;for(;o.value.length>=_;)o.value.pop();if(o.value.push(new Ne(v,D)),e){const d=e.replace(t.value+"/","").split("/");D.length===0?u=d.length-1:u<d.length&&(n.value=t.value+"/"+d.slice(0,u+1).join("/"),u++)}}},document:pe,variables:{dir:n,showHidden:!0},options:{fetchPolicy:"no-cache"},appApi:!0}),{refetch:T}=Y({handle:async(k,x)=>{if(x)J(c(x),"error");else{const{dir:v,items:I}=k.files,{fileIdToken:$}=s.value,D=[];for(const _ of I)D.push({..._,name:q(_.path),fileId:await X($,_.path)});o.value.forEach(_=>{_.dir===v&&(_.items=D)})}a.value=""},document:pe,variables:{dir:a,showHidden:!0},options:()=>({fetchPolicy:"no-cache",enabled:!!a.value}),appApi:!0});return{loading:F,panels:o,refetch(k){a.value=k,T()},rootDir:t,currentDir:n}},St=s=>({async download(e){const{fileIdToken:t}=s.value,a=await Ze(t,e);je(a+"&dl=1",q(e))}}),Pt=(s,e)=>({view(t,a){s.value=t.items.filter(o=>G(o.name)||N(o.name)||ge(o.name)).map(o=>({path:o.path,src:"",name:q(o.path)}));const n=kt(s.value,o=>o.path===a.path);e(n)}}),Bt=(s,e,t)=>{const a=m(null);return{selectedItem:a,select(n,o){o.isDir?s.value=o.path:n.items.some(u=>u.path===s.value)&&n.items.some(u=>u.path===o.path)&&(s.value=n.dir);const c=[];c.push({name:"path",op:"",value:o.path}),c.push({name:"dir",op:"",value:s.value}),e.value=vt(c),a.value=o,Ge(t,`/files?q=${Ue(e.value)}`)}}},qt=(s,e)=>{const t=m(null),a=m(null),n=m(!1),o=m(),{mutate:c,loading:u,onDone:F,onError:T}=B({document:We,appApi:!0}),{mutate:k,loading:x,onDone:v,onError:I}=B({document:ze,appApi:!0}),{t:$}=ee(),D=d=>{J($(d.message))};T(D),I(D);const _=()=>{var d;if(n.value){const g=a.value.items.findIndex(S=>S.path===t.value.path);(d=a.value)==null||d.items.splice(g,1)}t.value=null,setTimeout(()=>{s(o.value),e()},500)};return F(_),v(_),{loading:u||x,canPaste(){return!!t.value},copy(d){t.value=d,n.value=!1},cut(d,g){t.value=g,a.value=d,n.value=!0},paste(d){var S,A;o.value=d;const g={src:(S=t.value)==null?void 0:S.path,dst:d+"/"+((A=t.value)==null?void 0:A.name),overwrite:!1};n.value?k(g):c(g)}}},At=()=>{const{uploads:s}=K(_e()),e=m(""),t=m();return{input:t,upload(a){e.value=a,t.value.value="",t.value.click()},uploadChanged(a){const n=a.target.files;if(!n)return;const o=[];for(let c=0;c<n.length;c++){const u=n[c];o.push({dir:e.value,file:u,status:"created",uploadedSize:0,error:""})}s.value=[...s.value,...o]}}},Et=["disabled"],Lt=be({__name:"DeleteFileConfirm",props:{onDone:{type:Function,required:!0},file:{type:Object,required:!0}},setup(s){const e=s,{mutate:t,loading:a,onDone:n}=B({document:Oe`
    mutation DeleteFiles($paths: [String!]!) {
      deleteFiles(paths: $paths)
    }
  `,appApi:!0});function o(){t({paths:[e.file.path]})}return n(()=>{e.onDone(e.file),Xe()}),(c,u)=>{const F=bt;return f(),R(F,{class:"delete-modal",title:c.$t("confirm_to_delete_name",{name:s.file.name})},{action:H(()=>[y("button",{type:"button",disabled:i(a),class:"btn",onClick:o},V(c.$t("delete")),9,Et)]),_:1},8,["title"])}}}),Qt={class:"page-container container"},Rt={class:"main"},Ht={class:"v-toolbar"},Nt={class:"right-actions"},Gt={class:"form-check mt-2"},Ut={class:"form-check-label",for:"show-hidden"},Wt={class:"file-items"},zt=["onClick","onDblclick","onContextmenu"],Zt=["src"],jt={class:"title"},Ot={style:{"font-size":"0.75rem"}},Xt=["onContextmenu"],Yt={key:0,class:"no-files"},Jt={key:0,class:"file-item-info"},Kt=be({__name:"FilesView",setup(s){var ce,ue,re;const{t:e}=ee(),t=m([]),n=Ye().query,o=m(Je(((ce=n.q)==null?void 0:ce.toString())??"")),c=ft(o.value),u=m(((ue=c.find(l=>l.name==="path"))==null?void 0:ue.value)??""),F=m(((re=c.find(l=>l.name==="dir"))==null?void 0:re.value)??""),T=Ke(),{app:k}=K(_e()),{loading:x,panels:v,currentDir:I,refetch:$}=Tt(k,F.value),{visible:D,index:_,view:d,hide:g}=et(),{createPath:S,createVariables:A,createMutation:ye}=Vt(k,v),{renameValue:ke,renamePath:De,renameDone:we,renameMutation:Ce,renameVariables:xe}=$t(v),{totalBytes:Ie,freeBytes:Ve,refetch:U}=Mt(),{onDeleted:$e}=Ft(v,I,U),{download:te}=St(k),{view:ae}=Pt(t,d),{selectedItem:E,select:Fe}=Bt(I,o,T),{canPaste:ne,copy:se,cut:Me,paste:W}=qt($,U),{input:Te,upload:oe,uploadChanged:le}=At(),{fileShowHidden:P}=K(T);u.value&&tt(()=>v.value.length,()=>{if(v.value.length>0&&u.value){const r=v.value[v.value.length-1].items.find(p=>p.path===u.value);r&&(E.value=r,u.value="")}});function Se(){return`${e("page_title.files")} (${e("storage_free_total",{free:j(Ve.value),total:j(Ie.value)})})`}function Pe(l,r){Fe(l,r)}function ie(l){return G(l.name)||N(l.name)||ge(l.name)}function Be(l,r){r.isDir||(ie(r)?ae(l,r):te(r.path))}function qe(l,r){l.preventDefault();const p=[{label:e("create_folder"),onClick:()=>{S.value=r,O(fe,{title:e("name"),placeholder:e("name"),mutation:ye,getVariables:A})}},{label:e("upload_files"),onClick:()=>{oe(r)}}];ne()&&p.push({label:e("paste"),onClick:()=>{W(r)}}),he({x:l.x,y:l.y,items:p})}function Ae(l,r,p){l.preventDefault();let b;p.isDir?b=[{label:e("upload_files"),onClick:()=>{oe(p.path)}}]:(b=[],ie(p)&&b.push({label:e("open"),onClick:()=>{ae(r,p)}}),b.push({label:e("download"),onClick:()=>{te(p.path)}})),b.push({label:e("duplicate"),onClick:()=>{se(p),W(r.dir)}}),b.push({label:e("cut"),onClick:()=>{Me(r,p)}}),b.push({label:e("copy"),onClick:()=>{se(p)}}),p.isDir&&ne()&&b.push({label:e("paste"),onClick:()=>{W(p.path)}}),b=[...b,{label:e("rename"),onClick:()=>{ke.value=p.name,De.value=p.path,O(fe,{title:e("rename"),placeholder:e("name"),value:p.name,mutation:Ce,getVariables:xe,done:we})}},{label:e("delete"),onClick:()=>{O(Lt,{file:p,onDone:$e})}}],he({x:l.x,y:l.y,items:b})}return at(()=>{nt.on("upload_task_done",l=>{l.status==="done"&&setTimeout(()=>{$(l.dir),U()},1e3)})}),(l,r)=>{const p=pt,b=It,Ee=rt;return f(),C("div",Qt,[y("div",Rt,[y("div",Ht,[Z(p,{current:Se}),y("div",Nt,[y("div",Gt,[st(y("input",{class:"form-check-input","onUpdate:modelValue":r[0]||(r[0]=w=>lt(P)?P.value=w:null),id:"show-hidden",type:"checkbox"},null,512),[[ot,i(P)]]),y("label",Ut,V(l.$t("show_hidden")),1)])])]),Z(i(mt),{class:"panel-container"},{default:H(()=>[(f(!0),C(L,null,me(i(v),w=>(f(),R(i(ve),{key:w.dir},{default:H(()=>[y("div",Wt,[(f(!0),C(L,null,me(w.items,h=>{var de;return f(),C(L,{key:h.path},[!h.name.startsWith(".")||i(P)?(f(),C("div",{key:0,class:it(["file-item",{active:(i(I)+"/").startsWith(h.path+"/")||((de=i(E))==null?void 0:de.path)===h.path}]),onClick:z=>Pe(w,h),onDblclick:z=>Be(w,h),onContextmenu:z=>Ae(z,w,h)},[h.isDir?(f(),R(b,{key:0,class:"bi"})):M("",!0),i(G)(h.name)||i(N)(h.name)?(f(),C("img",{key:1,src:i(ct)(h.fileId)+"&w=50&h=50",width:"50",height:"50"},null,8,Zt)):M("",!0),y("div",jt,[Q(V(h.name)+" ",1),y("div",Ot,[Q(V(i(ut)(h.updatedAt)),1),h.isDir?M("",!0):(f(),C(L,{key:0},[Q(", "+V(i(j)(h.size)),1)],64))])])],42,zt)):M("",!0)],64)}),128)),y("div",{class:"empty",onContextmenu:h=>qe(h,w.dir)},[w.items.filter(h=>!h.name.startsWith(".")||i(P)).length===0?(f(),C("div",Yt,V(l.$t("no_files")),1)):M("",!0)],40,Xt)])]),_:2},1024))),128)),i(v).length===0?(f(),R(i(ve),{key:0,class:"no-data-placeholder"},{default:H(()=>[Q(V(l.$t(i(ht)(i(x),i(k).permissions,"WRITE_EXTERNAL_STORAGE"))),1)]),_:1})):M("",!0)]),_:1}),i(E)?(f(),C("div",Jt,V(l.$t("path"))+": "+V(i(E).path),1)):M("",!0),Z(Ee,{visible:i(D),index:i(_),sources:t.value,onHide:i(g)},null,8,["visible","index","sources","onHide"]),y("input",{ref_key:"fileInput",ref:Te,style:{display:"none"},type:"file",multiple:"",onChange:r[1]||(r[1]=(...w)=>i(le)&&i(le)(...w))},null,544)])])}}});const da=dt(Kt,[["__scopeId","data-v-52fdf4eb"]]);export{da as default};
